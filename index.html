<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏™‡∏°‡∏∏‡∏î‡∏à‡∏î‡∏´‡∏ß‡∏¢‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="theme-color" content="#5b21ff">
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Bootstrap + Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Prompt", sans-serif;
      background: radial-gradient(circle at top, #fde68a 0, #fdf2f8 35%, #e0f2fe 70%, #f9fafb 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .navbar {
      background: linear-gradient(135deg, #5b21ff, #2563eb);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.35);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .navbar-brand {
      color: #fff !important;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .navbar-brand span.emoji {
      font-size: 1.5rem;
      filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
    }
    .nav-pills .btn {
      border-radius: 999px;
      box-shadow: 0 3px 10px rgba(15,23,42,0.25);
    }
    .nav-pills .btn-check:checked + .btn {
      transform: translateY(1px);
    }
    .card {
      border-radius: 1.25rem;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
      border: 0;
      backdrop-filter: blur(18px);
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .pill {
      border-radius: 999px;
    }
    footer {
      margin-top: auto;
      padding: 0.75rem 0;
      text-align: center;
      font-size: 0.8rem;
      color: #6b7280;
    }

    /* ‡πÉ‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≤‡∏¢‡∏°‡∏π */
    .slip-wrapper {
      width: 260px;
      margin: 0 auto;
      background: #fefce8;
      color: #111827;
      border-radius: 8px;
      padding: 12px 14px;
      border: 1px dashed #f59e0b;
      box-shadow: 0 8px 20px rgba(15,23,42,0.13);
      font-size: 0.78rem;
    }
    .slip-header {
      text-align: center;
      margin-bottom: 6px;
    }
    .slip-header-title {
      font-weight: 600;
    }
    .slip-header-sub {
      font-size: 0.7rem;
      color: #6b7280;
    }
    .slip-divider {
      border-top: 1px dashed #d4b45a;
      margin: 6px 0;
    }
    .slip-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }
    .slip-label {
      color: #6b7280;
    }
    .slip-total {
      font-weight: 600;
      color: #b45309;
    }
    .badge-mu {
      background: linear-gradient(135deg,#f97316,#eab308);
      color:#111827;
    }

    @media (max-width: 768px) {
      .card {
        border-radius: 1rem;
      }
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg mb-3">
  <div class="container">
    <a class="navbar-brand" href="#" onclick="showSection('people')">
      <span class="emoji">üìí</span>
      <span>‡∏™‡∏°‡∏∏‡∏î‡∏à‡∏î‡∏´‡∏ß‡∏¢</span>
    </a>

    <div class="ms-auto d-flex gap-2 nav-pills">
      <input type="radio" class="btn-check" name="navMode" id="nav-people" autocomplete="off" checked
             onclick="showSection('people')">
      <label class="btn btn-sm btn-light" for="nav-people">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</label>

      <input type="radio" class="btn-check" name="navMode" id="nav-records" autocomplete="off"
             onclick="showSection('records')">
      <label class="btn btn-sm btn-light" for="nav-records">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç</label>

      <input type="radio" class="btn-check" name="navMode" id="nav-check" autocomplete="off"
             onclick="showSection('check')">
      <label class="btn btn-sm btn-warning text-dark" for="nav-check">‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label>
    </div>
  </div>
</nav>

<div class="container mb-4 flex-grow-1">

  <!-- SECTION: ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ -->
  <div id="section-people" class="section active">
    <div class="row g-4">
      <div class="col-md-6">
        <div class="card p-3">
          <div class="card-body">
            <h5 class="card-title mb-3">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏î‡πÄ‡∏•‡∏Ç</h5>
            <ul id="person-list" class="list-group small"></ul>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-3">
          <div class="card-body">
            <h5 class="card-title mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà</h5>
            <form onsubmit="addPerson(event)">
              <div class="mb-2">
                <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠</label>
                <input type="text" id="person-name" class="form-control" required>
              </div>
              <div class="mb-2">
                <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <input type="text" id="person-note" class="form-control">
              </div>
              <button type="submit" class="btn btn-primary w-100 mt-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç -->
  <div id="section-records" class="section">
    <div class="row g-4">
      <div class="col-md-5">
        <div class="card p-3">
          <div class="card-body">
            <h5 class="card-title mb-3">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà</h5>
            <form onsubmit="addRecord(event)">
              <div class="mb-2">
                <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠</label>
                <select id="record-person-id" class="form-select" required></select>
              </div>
              <div class="mb-2">
                <label class="form-label">‡∏á‡∏ß‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <input type="date" id="record-date" class="form-control">
              </div>
              <div class="mb-2">
                <label class="form-label">‡πÄ‡∏•‡∏Ç</label>
                <input type="text" id="record-number" class="form-control" maxlength="3"
                       placeholder="‡πÄ‡∏ä‡πà‡∏ô 23 ‡∏´‡∏£‡∏∑‡∏≠ 123" required>
              </div>
              <div class="mb-2">
                <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å</label>
                <select id="record-digits" class="form-select">
                  <option value="2">‡πÄ‡∏•‡∏Ç 2 ‡∏ï‡∏±‡∏ß</option>
                  <option value="3" selected>‡πÄ‡∏•‡∏Ç 3 ‡∏ï‡∏±‡∏ß</option>
                  <option value="1">‡πÄ‡∏•‡∏Ç‡∏ß‡∏¥‡πà‡∏á 1 ‡∏ï‡∏±‡∏ß</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <select id="record-bettype" class="form-select">
                  <option value="‡∏ö‡∏ô">‡∏ö‡∏ô</option>
                  <option value="‡∏•‡πà‡∏≤‡∏á">‡∏•‡πà‡∏≤‡∏á</option>
                  <option value="3‡∏ï‡∏±‡∏ß‡∏ï‡∏£‡∏á">3‡∏ï‡∏±‡∏ß‡∏ï‡∏£‡∏á</option>
                  <option value="3‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤">3‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</option>
                  <option value="‡πÇ‡∏ï‡πä‡∏î">‡πÇ‡∏ï‡πä‡∏î</option>
                  <option value="‡∏ß‡∏¥‡πà‡∏á">‡∏ß‡∏¥‡πà‡∏á</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏•‡πà‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                <input type="number" id="record-stake" class="form-control" min="1" step="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10">
              </div>
              <div class="mb-2">
                <label class="form-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó / 1 ‡∏ö‡∏≤‡∏ó‡πÅ‡∏ó‡∏á)</label>
                <input type="number" id="record-rate" class="form-control" min="1" step="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 60">
              </div>
              <div class="mb-2">
                <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°</label>
                <input type="text" id="record-remark" class="form-control">
              </div>
              <button type="submit" class="btn btn-success w-100 mt-2">
                <span id="record-submit-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç</span>
              </button>
              <button type="button" class="btn btn-outline-danger w-100 mt-2" id="record-cancel-edit"
                      onclick="cancelEditRecord()" style="display:none;">
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
              </button>
            </form>
            <button class="btn btn-outline-secondary w-100 mt-3" onclick="showSection('people')">
              ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </button>
          </div>
        </div>
      </div>

      <div class="col-md-7">
        <div class="card p-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="card-title mb-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
              <div class="small text-muted">
                ‡∏õ‡∏∏‡πà‡∏° <span class="badge bg-secondary pill">‡∏™‡∏•‡∏¥‡∏õ</span> ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏û‡∏¢ / <span class="badge bg-primary pill">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span> ‡πÅ‡∏Å‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á</label>
              <select id="filter-person-id" class="form-select form-select-sm" onchange="renderRecordList()"></select>
            </div>
            <div class="table-responsive" style="max-height: 420px; overflow:auto;">
              <table class="table table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th>‡∏á‡∏ß‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th>‡πÄ‡∏•‡∏Ç</th>
                    <th>‡πÄ‡∏•‡πà‡∏ô</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                    <th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏à‡πà‡∏≤‡∏¢</th>
                    <th>‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                    <th>‡∏™‡∏•‡∏¥‡∏õ / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                  </tr>
                </thead>
                <tbody id="record-list"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION: ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• -->
  <div id="section-check" class="section">
    <div class="row g-4">
      <div class="col-md-4">
        <div class="card p-3">
          <div class="card-body">
            <h5 class="card-title mb-3">‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h5>
            <form onsubmit="checkWinners(event)">
              <div class="mb-2">
                <label class="form-label">‡∏á‡∏ß‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á)</label>
                <input type="date" id="check-date" class="form-control">
              </div>
              <div class="mb-2">
                <label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</label>
                <input type="text" id="check-number" class="form-control" maxlength="3"
                       placeholder="‡πÄ‡∏ä‡πà‡∏ô 23 ‡∏´‡∏£‡∏∑‡∏≠ 123" required>
              </div>
              <div class="mb-2">
                <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å</label>
                <select id="check-digits" class="form-select">
                  <option value="2">‡πÄ‡∏•‡∏Ç 2 ‡∏ï‡∏±‡∏ß</option>
                  <option value="3" selected>‡πÄ‡∏•‡∏Ç 3 ‡∏ï‡∏±‡∏ß</option>
                  <option value="1">‡πÄ‡∏•‡∏Ç‡∏ß‡∏¥‡πà‡∏á 1 ‡∏ï‡∏±‡∏ß</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <select id="check-bettype" class="form-select">
                  <option value="‡∏ö‡∏ô">‡∏ö‡∏ô</option>
                  <option value="‡∏•‡πà‡∏≤‡∏á">‡∏•‡πà‡∏≤‡∏á</option>
                  <option value="3‡∏ï‡∏±‡∏ß‡∏ï‡∏£‡∏á">3‡∏ï‡∏±‡∏ß‡∏ï‡∏£‡∏á</option>
                  <option value="3‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤">3‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</option>
                  <option value="‡πÇ‡∏ï‡πä‡∏î">‡πÇ‡∏ï‡πä‡∏î</option>
                  <option value="‡∏ß‡∏¥‡πà‡∏á">‡∏ß‡∏¥‡πà‡∏á</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary w-100 mt-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å</button>
            </form>
            <button class="btn btn-outline-secondary w-100 mt-3" onclick="showSection('people')">
              ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
            </button>
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <div class="card p-3">
          <div class="card-body">
            <h5 class="card-title mb-1">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h5>
            <p class="small text-muted" id="check-summary"></p>
            <div class="table-responsive" style="max-height: 420px; overflow:auto;">
              <table class="table table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th>‡∏á‡∏ß‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th>‡πÄ‡∏•‡∏Ç</th>
                    <th>‡πÄ‡∏•‡πà‡∏ô</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                    <th>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏à‡πà‡∏≤‡∏¢</th>
                    <th>‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                    <th>‡∏™‡∏•‡∏¥‡∏õ / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                  </tr>
                </thead>
                <tbody id="check-result-list"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<footer>
  ¬© ‡∏ô‡πâ‡∏≤‡πÅ‡∏ï‡πä‡∏Å ‚Äì ‡∏™‡∏°‡∏∏‡∏î‡∏à‡∏î‡∏´‡∏ß‡∏¢‡∏™‡∏≤‡∏¢‡∏°‡∏π
</footer>

<!-- Modal ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏•‡∏¥‡∏õ -->
<div class="modal fade" id="slipModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0">
      <div class="modal-header py-2">
        <h6 class="modal-title">‡πÉ‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="‡∏õ‡∏¥‡∏î"></button>
      </div>
      <div class="modal-body d-flex flex-column align-items-center">
        <div id="slip-area" class="slip-wrapper">
          <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
        </div>
        <button class="btn btn-sm btn-outline-primary mt-3" onclick="downloadSlipImage()">
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  // --------- PWA Service Worker ----------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').catch(err => {
        console.log('SW reg error', err);
      });
    });
  }

  // --------- Data State ----------
  let state = {
    persons: [],
    records: [],
    nextPersonId: 1,
    nextRecordId: 1
  };

  let editingRecordId = null;

  function loadState() {
    const raw = localStorage.getItem('lottoState');
    if (raw) {
      try {
        state = JSON.parse(raw);
      } catch (e) {
        console.error('load error', e);
      }
    }
    if (!state.nextPersonId) {
      state.nextPersonId = (state.persons?.length || 0) + 1;
    }
    if (!state.nextRecordId) {
      state.nextRecordId = (state.records?.length || 0) + 1;
    }
    cleanupOldRecords();
  }

  function saveState() {
    localStorage.setItem('lottoState', JSON.stringify(state));
  }

  // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô 24 ‡∏ä‡∏°. ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
  function cleanupOldRecords() {
    const now = new Date();
    let changed = false;
    state.records = (state.records || []).filter(r => {
      if (!r.drawDate) return true; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏á‡∏ß‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏ß‡πâ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏•‡∏ö
      const parts = r.drawDate.split('-');
      if (parts.length !== 3) return true;
      const d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
      d.setDate(d.getDate() + 1); // +1 ‡∏ß‡∏±‡∏ô = 24 ‡∏ä‡∏°.
      if (now > d) {
        changed = true;
        return false;
      }
      return true;
    });
    if (changed) {
      saveState();
    }
  }

  // --------- UI Helper ----------
  function showSection(name) {
    document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
    document.getElementById('section-' + name).classList.add('active');
    const navId = 'nav-' + name;
    const nav = document.getElementById(navId);
    if (nav) nav.checked = true;
  }

  function digitsLabel(d) {
    if (d === 2) return '‡πÄ‡∏•‡∏Ç 2 ‡∏ï‡∏±‡∏ß';
    if (d === 3) return '‡πÄ‡∏•‡∏Ç 3 ‡∏ï‡∏±‡∏ß';
    if (d === 1) return '‡πÄ‡∏•‡∏Ç‡∏ß‡∏¥‡πà‡∏á 1 ‡∏ï‡∏±‡∏ß';
    return d;
  }

  function formatMoney(val) {
    if (!val || isNaN(val)) return '-';
    return Number(val).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // --------- Persons ----------
  function renderPersonList() {
    const ul = document.getElementById('person-list');
    ul.innerHTML = '';
    if (!state.persons.length) {
      ul.innerHTML = '<li class="list-group-item text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</li>';
      return;
    }
    state.persons.forEach(p => {
      const count = state.records.filter(r => r.personId === p.id).length;
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';

      li.innerHTML = `
        <div style="cursor:pointer" onclick="openPersonRecords(${p.id})">
          <strong>${p.name}</strong>
          ${p.note ? `<div class="small text-muted">${p.note}</div>` : ''}
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-primary pill">${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
          <button class="btn btn-sm btn-outline-primary" onclick="editPerson(${p.id}, event)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </div>
      `;
      ul.appendChild(li);
    });

    const selRecord = document.getElementById('record-person-id');
    const selFilter = document.getElementById('filter-person-id');
    selRecord.innerHTML = '';
    selFilter.innerHTML = '';

    const defaultOpt = document.createElement('option');
    defaultOpt.value = '';
    defaultOpt.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠...';
    selRecord.appendChild(defaultOpt);

    const allOpt = document.createElement('option');
    allOpt.value = '';
    allOpt.textContent = '‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô';
    selFilter.appendChild(allOpt);

    state.persons.forEach(p => {
      const o1 = document.createElement('option');
      o1.value = p.id;
      o1.textContent = p.name;
      selRecord.appendChild(o1);

      const o2 = document.createElement('option');
      o2.value = p.id;
      o2.textContent = p.name;
      selFilter.appendChild(o2);
    });
  }

  function addPerson(e) {
    e.preventDefault();
    const name = document.getElementById('person-name').value.trim();
    const note = document.getElementById('person-note').value.trim();
    if (!name) return;
    state.persons.push({
      id: state.nextPersonId++,
      name,
      note
    });
    saveState();
    renderPersonList();
    document.getElementById('person-name').value = '';
    document.getElementById('person-note').value = '';
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
  }

  function editPerson(id, ev) {
    if (ev) ev.stopPropagation();
    const p = state.persons.find(x => x.id === id);
    if (!p) return;
    const newName = prompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠', p.name);
    if (!newName) return;
    const newNote = prompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)', p.note || '');
    p.name = newName.trim();
    p.note = (newNote || '').trim();
    saveState();
    renderPersonList();
    renderRecordList();
  }

  function openPersonRecords(personId) {
    document.getElementById('filter-person-id').value = String(personId);
    showSection('records');
    renderRecordList();
  }

  // --------- Records ----------
  function renderRecordList() {
    const tbody = document.getElementById('record-list');
    tbody.innerHTML = '';
    if (!state.records.length) {
      tbody.innerHTML = '<tr><td colspan="9" class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏Ç</td></tr>';
      return;
    }
    const filterId = parseInt(document.getElementById('filter-person-id').value || '0', 10);
    const sorted = [...state.records].sort((a, b) => b.id - a.id);

    sorted.forEach(r => {
      if (filterId && r.personId !== filterId) return;
      const p = state.persons.find(p => p.id === r.personId);
      const stake = Number(r.stake || 0);
      const rate  = Number(r.payoutRate || 0);
      const potential = stake && rate ? stake * rate : null;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p ? p.name : '-'}</td>
        <td>${r.drawDate || '-'}</td>
        <td>${r.number}</td>
        <td>${digitsLabel(r.digits)}</td>
        <td>${r.betType}</td>
        <td>${stake ? formatMoney(stake) : '-'}</td>
        <td>${rate ? formatMoney(rate) : '-'}</td>
        <td>${potential ? formatMoney(potential) : '-'}</td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" onclick="showSlip(${r.id})">‡∏™‡∏•‡∏¥‡∏õ</button>
            <button class="btn btn-outline-primary" onclick="startEditRecord(${r.id})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function addRecord(e) {
    e.preventDefault();
    const personId = parseInt(document.getElementById('record-person-id').value || '0', 10);
    const drawDate = document.getElementById('record-date').value || '';
    const number = document.getElementById('record-number').value.trim();
    const digits = parseInt(document.getElementById('record-digits').value, 10);
    const betType = document.getElementById('record-bettype').value;
    const stakeVal = document.getElementById('record-stake').value;
    const rateVal  = document.getElementById('record-rate').value;
    const remark = document.getElementById('record-remark').value.trim();

    if (!personId) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠');
      return;
    }
    if (!number) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç');
      return;
    }
    if (digits === 2 && number.length !== 2) {
      alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç 2 ‡∏ï‡∏±‡∏ß ‡πÅ‡∏ï‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 2 ‡∏´‡∏•‡∏±‡∏Å');
      return;
    }
    if (digits === 3 && number.length !== 3) {
      alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç 3 ‡∏ï‡∏±‡∏ß ‡πÅ‡∏ï‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 3 ‡∏´‡∏•‡∏±‡∏Å');
      return;
    }
    if (digits === 1 && number.length !== 1) {
      alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ß‡∏¥‡πà‡∏á 1 ‡∏ï‡∏±‡∏ß ‡πÅ‡∏ï‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 1 ‡∏´‡∏•‡∏±‡∏Å');
      return;
    }

    const stake = stakeVal ? Number(stakeVal) : null;
    const payoutRate = rateVal ? Number(rateVal) : null;

    if (editingRecordId) {
      // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
      const r = state.records.find(x => x.id === editingRecordId);
      if (r) {
        r.personId = personId;
        r.drawDate = drawDate;
        r.number = number;
        r.digits = digits;
        r.betType = betType;
        r.stake = stake;
        r.payoutRate = payoutRate;
        r.remark = remark;
      }
      editingRecordId = null;
      document.getElementById('record-submit-text').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç';
      document.getElementById('record-cancel-edit').style.display = 'none';
    } else {
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
      state.records.push({
        id: state.nextRecordId++,
        personId,
        drawDate,
        number,
        digits,
        betType,
        stake,
        payoutRate,
        remark
      });
    }

    saveState();
    renderRecordList();
    renderPersonList();

    document.getElementById('record-number').value = '';
    document.getElementById('record-remark').value = '';
    document.getElementById('record-stake').value = '';
    document.getElementById('record-rate').value = '';
  }

  function startEditRecord(id) {
    const r = state.records.find(x => x.id === id);
    if (!r) return;
    editingRecordId = id;
    document.getElementById('record-person-id').value = r.personId;
    document.getElementById('record-date').value = r.drawDate || '';
    document.getElementById('record-number').value = r.number;
    document.getElementById('record-digits').value = String(r.digits);
    document.getElementById('record-bettype').value = r.betType;
    document.getElementById('record-stake').value = r.stake ?? '';
    document.getElementById('record-rate').value = r.payoutRate ?? '';
    document.getElementById('record-remark').value = r.remark || '';

    document.getElementById('record-submit-text').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
    document.getElementById('record-cancel-edit').style.display = 'block';

    showSection('records');
  }

  function cancelEditRecord() {
    editingRecordId = null;
    document.getElementById('record-submit-text').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç';
    document.getElementById('record-cancel-edit').style.display = 'none';
    document.getElementById('record-number').value = '';
    document.getElementById('record-remark').value = '';
    document.getElementById('record-stake').value = '';
    document.getElementById('record-rate').value = '';
  }

  // --------- Check Winners ----------
  function checkWinners(e) {
    e.preventDefault();
    const drawDate = document.getElementById('check-date').value || '';
    const number = document.getElementById('check-number').value.trim();
    const digits = parseInt(document.getElementById('check-digits').value, 10);
    const betType = document.getElementById('check-bettype').value;

    if (!number) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å');
      return;
    }

    let results = state.records.filter(r => {
      if (drawDate && r.drawDate !== drawDate) return false;
      if (r.digits !== digits) return false;
      if (r.number !== number) return false;
      if (r.betType !== betType) return false;
      return true;
    });

    const tbody = document.getElementById('check-result-list');
    tbody.innerHTML = '';

    if (!results.length) {
      tbody.innerHTML = '<tr><td colspan="9" class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ</td></tr>';
    } else {
      results.forEach(r => {
        const p = state.persons.find(p => p.id === r.personId);
        const stake = Number(r.stake || 0);
        const rate  = Number(r.payoutRate || 0);
        const potential = stake && rate ? stake * rate : null;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="badge badge-mu pill">${p ? p.name : '-'}</span></td>
          <td>${r.drawDate || '-'}</td>
          <td><strong>${r.number}</strong></td>
          <td>${digitsLabel(r.digits)}</td>
          <td>${r.betType}</td>
          <td>${stake ? formatMoney(stake) : '-'}</td>
          <td>${rate ? formatMoney(rate) : '-'}</td>
          <td>${potential ? formatMoney(potential) : '-'}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-secondary" onclick="showSlip(${r.id})">‡∏™‡∏•‡∏¥‡∏õ</button>
              <button class="btn btn-outline-primary" onclick="startEditRecord(${r.id})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    const summary = document.getElementById('check-summary');
    summary.textContent = `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å: ${number} (${digitsLabel(digits)}, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ${betType})` +
      (drawDate ? ` | ‡∏á‡∏ß‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${drawDate}` : '');
  }

  // --------- Slip (‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏û‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô + ‡∏á‡∏ß‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô) ----------
  let slipModal;
  let currentSlipRecordId = null;

  function showSlip(recordId) {
    const r = state.records.find(x => x.id === recordId);
    if (!r) return;
    currentSlipRecordId = recordId;
    const p = state.persons.find(p => p.id === r.personId);

    // ‡∏£‡∏ß‡∏°‡πÇ‡∏û‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô + ‡∏á‡∏ß‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
    const sameDraw = state.records.filter(x =>
      x.personId === r.personId &&
      (r.drawDate ? x.drawDate === r.drawDate : true)
    );

    let totalStake = 0;
    let totalPotential = 0;

    const slip = document.getElementById('slip-area');
    const now = new Date();

    let rowsHtml = '';
    sameDraw.forEach(item => {
      const stake = Number(item.stake || 0);
      const rate  = Number(item.payoutRate || 0);
      const potential = stake && rate ? stake * rate : 0;
      if (stake) totalStake += stake;
      if (potential) totalPotential += potential;

      rowsHtml += `
        <div class="slip-row">
          <span>${item.number} (${digitsLabel(item.digits)}, ${item.betType})</span>
          <span>${stake ? formatMoney(stake) + '‡∏ö.' : '-'}</span>
        </div>
      `;
    });

    slip.innerHTML = `
      <div class="slip-header">
        <div class="slip-header-title">‡∏™‡∏°‡∏∏‡∏î‡∏à‡∏î‡∏´‡∏ß‡∏¢‡∏™‡∏≤‡∏¢‡∏°‡∏π</div>
        <div class="slip-header-sub">‡πÇ‡∏û‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ¬∑ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏™‡∏•‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô‡πÅ‡∏ö‡πà‡∏á</div>
      </div>
      <div class="slip-divider"></div>
      <div class="slip-row">
        <span class="slip-label">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
        <span>${p ? p.name : '-'}</span>
      </div>
      <div class="slip-row">
        <span class="slip-label">‡∏á‡∏ß‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
        <span>${r.drawDate || '-'}</span>
      </div>
      <div class="slip-divider"></div>
      ${rowsHtml || '<div class="slip-row"><span>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</span><span></span></div>'}
      <div class="slip-divider"></div>
      <div class="slip-row">
        <span class="slip-label">‡∏¢‡∏≠‡∏î‡πÅ‡∏ó‡∏á‡∏£‡∏ß‡∏°</span>
        <span>${totalStake ? formatMoney(totalStake) + ' ‡∏ö.' : '-'}</span>
      </div>
      <div class="slip-row slip-total">
        <span>‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏´‡∏≤‡∏Å‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
        <span>${totalPotential ? formatMoney(totalPotential) + ' ‡∏ö.' : '-'}</span>
      </div>
      ${r.remark ? `
        <div class="slip-divider"></div>
        <div class="slip-row">
          <span class="slip-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
          <span>${r.remark}</span>
        </div>
      ` : ''}
      <div class="slip-divider"></div>
      <div class="text-center" style="font-size:0.68rem; color:#6b7280;">
        ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏î‡∏¢ ‡∏ô‡πâ‡∏≤‡πÅ‡∏ï‡πä‡∏Å ¬∑ ${now.toLocaleString('th-TH')}
      </div>
    `;

    if (!slipModal) {
      slipModal = new bootstrap.Modal(document.getElementById('slipModal'));
    }
    slipModal.show();
  }

  function downloadSlipImage() {
    const slip = document.getElementById('slip-area');
    if (!slip) return;
    html2canvas(slip, { scale: 3 }).then(canvas => {
      const link = document.createElement('a');
      const r = state.records.find(x => x.id === currentSlipRecordId);
      const p = r ? state.persons.find(pp => pp.id === r.personId) : null;
      const namePart = p ? p.name : 'slip';
      link.download = `slip_${namePart}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    });
  }

  // --------- Init ----------
  loadState();
  renderPersonList();
  renderRecordList();
</script>

</body>
</html>
